# name: test/sql/stats/recursive_cte_partitioned.test
# description: Test for DuckLake with recursive CTE (identical logic to test/sql/copy/partitioned/hive_partition_recursive_cte.test)
# group: [stats]

require ducklake

require parquet

test-env DUCKLAKE_CONNECTION __TEST_DIR__/{UUID}.db

test-env DATA_PATH __TEST_DIR__

statement ok
ATTACH 'ducklake:${DUCKLAKE_CONNECTION}' AS ducklake (DATA_PATH '${DATA_PATH}/ducklake_recursive_cte_files')

# create a table
statement ok
CREATE TABLE ducklake.t AS SELECT 2000+i%10 AS year, 1+i%3 AS month, i%4 AS c, i%5 AS d FROM RANGE(0,20) tbl(i);

loop i 0 2

# this recursive CTE iterates over the years (2000...2009) and counts the number of rows in each of the years
# then at the end we add everything up

query III
WITH RECURSIVE cte AS (
	SELECT 0 AS count, 1999 AS selected_year
	UNION ALL
	SELECT COUNT(*) AS count, MAX(t.year)
	FROM ducklake.t, (SELECT MAX(selected_year) AS next_year FROM cte)
	WHERE t.year = (SELECT MAX(selected_year) + 1 FROM cte)
	HAVING COUNT(*)>0
)
SELECT SUM(count), MIN(selected_year), MAX(selected_year)
FROM cte
WHERE count>0
----
20	2000	2009

endloop
