# name: test/sql/merge/merge_partition.test
# description: Test merge into with partitions
# group: [merge]

require ducklake

require parquet

require icu

test-env DUCKLAKE_CONNECTION __TEST_DIR__/{UUID}.db

statement ok
ATTACH 'ducklake:${DUCKLAKE_CONNECTION}' AS ducklake (DATA_PATH '__TEST_DIR__/merge_partition', METADATA_CATALOG 'ducklake_meta')

statement ok
USE ducklake

statement ok
CREATE TABLE my_timeseries (ts TIMESTAMPTZ, x DOUBLE PRECISION);

statement ok
ALTER TABLE my_timeseries SET PARTITIONED BY (year(ts));

statement ok
MERGE INTO my_timeseries
    USING (
        SELECT
            '2025-09-17'::TIMESTAMPTZ as ts,
            42::DOUBLE PRECISION as x
    ) AS timeseries_updates
    ON my_timeseries.ts = timeseries_updates.ts
    WHEN NOT MATCHED THEN INSERT;

query I
SELECT COUNT (*) FROM my_timeseries
----
1