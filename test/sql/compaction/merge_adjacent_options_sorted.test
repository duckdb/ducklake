# name: test/sql/compaction/merge_adjacent_options.test
# description: test ducklake merge adjacent files options
# group: [compaction]

require ducklake

require parquet

test-env DUCKLAKE_CONNECTION __TEST_DIR__/{UUID}.db

statement ok
ATTACH 'ducklake:${DUCKLAKE_CONNECTION}' AS ducklake (DATA_PATH '__TEST_DIR__/merge_adjacent_options_sorted/')

statement ok
USE ducklake;

##############################################
# Parameter in ducklake_merge_adjacent_files #
##############################################
# Create one Table with two files
statement ok
CREATE TABLE sort_with_parameter (unique_id BIGINT, sort_key_1 BIGINT, sort_key_2 VARCHAR);

statement ok
INSERT INTO sort_with_parameter (unique_id, sort_key_1, sort_key_2)
FROM range(4) t(i)
SELECT 
    i AS unique_id,
    i % 2 AS sort_key_1,
    'woot' || i AS sort_key_2
ORDER BY 
    i DESC
;

statement ok
INSERT INTO sort_with_parameter (unique_id, sort_key_1, sort_key_2)
FROM range(4) t(i)
SELECT 
    i + 4 AS unique_id,
    (i + 4) % 2 AS sort_key_1,
    'woot' || (i + 4) AS sort_key_2
ORDER BY 
    i DESC
;

query III
FROM sort_with_parameter
----
3	1	woot3
2	0	woot2
1	1	woot1
0	0	woot0
7	1	woot7
6	0	woot6
5	1	woot5
4	0	woot4

query II
SELECT df.data_file_id, df.table_id 
FROM __ducklake_metadata_ducklake.ducklake_data_file df 
JOIN __ducklake_metadata_ducklake.ducklake_table t 
ON df.table_id = t.table_id 
WHERE 
t.table_name = 'sort_with_parameter'
----
0	1
1	1

statement ok
CALL ducklake_merge_adjacent_files('ducklake', 'sort_with_parameter', local_order_by => 'sort_key_1 ASC,sort_key_2 ASC');

query III
FROM sort_with_parameter
--ORDER BY 
--    sort_key_1 ASC,
--    sort_key_2 ASC
----
0	0	woot0
2	0	woot2
4	0	woot4
6	0	woot6
1	1	woot1
3	1	woot3
5	1	woot5
7	1	woot7

# We write a new file for table id 2
query II
SELECT df.data_file_id, df.table_id 
FROM __ducklake_metadata_ducklake.ducklake_data_file df 
JOIN __ducklake_metadata_ducklake.ducklake_table t 
ON df.table_id = t.table_id 
WHERE 
t.table_name = 'sort_with_parameter'
----
2	1

################################ 
# Configuration via set_option #
################################
# Create one Table with two files
statement ok
CREATE TABLE sort_with_setting (unique_id BIGINT, sort_key_1 BIGINT, sort_key_2 VARCHAR);

statement ok
INSERT INTO sort_with_setting (unique_id, sort_key_1, sort_key_2)
FROM range(4) t(i)
SELECT 
    i AS unique_id,
    i % 2 AS sort_key_1,
    'woot' || i AS sort_key_2
ORDER BY 
    i DESC
;

statement ok
INSERT INTO sort_with_setting (unique_id, sort_key_1, sort_key_2)
FROM range(4) t(i)
SELECT 
    i + 4 AS unique_id,
    (i + 4) % 2 AS sort_key_1,
    'woot' || (i + 4) AS sort_key_2
ORDER BY 
    i DESC
;

query III
FROM sort_with_setting
----
3	1	woot3
2	0	woot2
1	1	woot1
0	0	woot0
7	1	woot7
6	0	woot6
5	1	woot5
4	0	woot4

query II
SELECT df.data_file_id, df.table_id 
FROM __ducklake_metadata_ducklake.ducklake_data_file df 
JOIN __ducklake_metadata_ducklake.ducklake_table t 
ON df.table_id = t.table_id 
WHERE 
t.table_name = 'sort_with_setting'
----
3	2
4	2

statement ok
CALL ducklake.set_option('local_order_by', 'sort_key_1 ASC ,   sort_key_2 ASC', table_name => 'sort_with_setting');

statement ok
CALL ducklake_merge_adjacent_files('ducklake', 'sort_with_setting');

query III
FROM sort_with_setting
--ORDER BY 
--    sort_key_1 ASC,
--    sort_key_2 ASC
----
0	0	woot0
2	0	woot2
4	0	woot4
6	0	woot6
1	1	woot1
3	1	woot3
5	1	woot5
7	1	woot7

# We write a new file for table id 2
query II
SELECT df.data_file_id, df.table_id 
FROM __ducklake_metadata_ducklake.ducklake_data_file df 
JOIN __ducklake_metadata_ducklake.ducklake_table t 
ON df.table_id = t.table_id 
WHERE 
t.table_name = 'sort_with_setting'
----
5	2


######################################
# Column does not exist in the table #
######################################
statement ok
CALL ducklake.set_option('local_order_by', 'WOOOOT ASC ,   BLAH ASC', table_name => 'sort_with_setting');

statement ok
INSERT INTO sort_with_setting (unique_id, sort_key_1, sort_key_2)
select 1000, 1000, 'anything';

statement error
CALL ducklake_merge_adjacent_files('ducklake', 'sort_with_setting');
----
Binder Error: Columns in the approx_sort parameter were not found in the DuckLake table. Unmatched columns were: WOOOOT, BLAH


