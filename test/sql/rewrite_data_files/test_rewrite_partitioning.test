# name: test/sql/rewrite_data_files/test_rewrite_partitioning.test
# description: Test rewrite_data_files on partitioned tables with delete files created via MERGE
# group: [rewrite_data_files]

require ducklake

require parquet

test-env DUCKLAKE_CONNECTION __TEST_DIR__/{UUID}.db

test-env DATA_PATH __TEST_DIR__


statement ok
ATTACH 'ducklake:${DUCKLAKE_CONNECTION}' AS ducklake (DATA_PATH '${DATA_PATH}/rewrite_partitioned', METADATA_CATALOG 'ducklake_metadata')

statement ok
USE ducklake

# Create a partitioned table
statement ok
CREATE TABLE partitioned(part_key INTEGER, id INTEGER, value INTEGER);

statement ok
ALTER TABLE partitioned SET PARTITIONED BY (part_key);

# Initial data load into multiple partitions
statement ok
INSERT INTO partitioned VALUES (1, 1, 10), (1, 2, 20);

statement ok
INSERT INTO partitioned VALUES (2, 1, 100), (2, 2, 200);

# We should have 2 data files (one per insert, but inserts had multiple rows)
query I
SELECT COUNT(*) FROM GLOB('${DATA_PATH}/rewrite_partitioned/**/*.parquet')
----
2

# Simulate incremental load with MERGE (upsert pattern)
# This updates existing rows and inserts new ones, creating delete files
statement ok
CREATE TEMP TABLE _merge_source AS
SELECT * FROM (VALUES (1, 1, 15), (1, 3, 30), (2, 1, 150), (2, 3, 300)) AS t(part_key, id, value);

statement ok
MERGE INTO partitioned AS target
USING _merge_source AS source
ON (target.part_key = source.part_key AND target.id = source.id)
WHEN MATCHED THEN UPDATE SET value = source.value
WHEN NOT MATCHED THEN INSERT *;

# Verify delete files were created by MERGE
query I
SELECT COUNT(*) FROM ducklake_metadata.ducklake_delete_file WHERE end_snapshot IS NULL
----
2

# Verify data is correct after merge
query III
SELECT * FROM partitioned ORDER BY part_key, id
----
1	1	15
1	2	20
1	3	30
2	1	150
2	2	200
2	3	300

# This should rewrite files with deletes, grouping by partition
# Currently this fails with: "DuckLakeCompactor: Files have different hive partition path"
statement ok
CALL ducklake_rewrite_data_files('ducklake', 'partitioned', delete_threshold => 0);

# After rewrite, delete files should be gone (applied to new data files)
query I
SELECT COUNT(*) FROM ducklake_metadata.ducklake_delete_file WHERE end_snapshot IS NULL
----
0

# Verify data is still correct after rewrite
query III
SELECT * FROM partitioned ORDER BY part_key, id
----
1	1	15
1	2	20
1	3	30
2	1	150
2	2	200
2	3	300

# Merge adjacent files to consolidate (rewrite doesn't merge, just applies deletes)
statement ok
CALL ducklake_merge_adjacent_files('ducklake', 'partitioned');

# Cleanup old files
statement ok
CALL ducklake_cleanup_old_files('ducklake', cleanup_all => true);

# Verify partition info is preserved correctly - should have 2 files (one per partition)
query II
SELECT partition_id, partition_value
FROM ducklake_metadata.ducklake_data_file
JOIN ducklake_metadata.ducklake_file_partition_value USING (data_file_id)
WHERE end_snapshot IS NULL
ORDER BY partition_value
----
2	1
2	2