# name: test/sql/sorted_table/schema_version_mixed_operations.test
# description: Verify schema_version increments correctly with mixed operations
# group: [sorted_table]

require ducklake

require parquet

test-env DUCKLAKE_CONNECTION __TEST_DIR__/{UUID}.db

statement ok
ATTACH 'ducklake:${DUCKLAKE_CONNECTION}' AS ducklake (DATA_PATH '__TEST_DIR__/mixed_ops_test/')

statement ok
CREATE TABLE ducklake.test(a INTEGER, b VARCHAR);

query I
SELECT max(schema_version) FROM __ducklake_metadata_ducklake.ducklake_schema_versions where table_id = 1
----
1

# SET SORTED BY should NOT increment
statement ok
ALTER TABLE ducklake.test SET SORTED BY (a ASC);

query I
SELECT max(schema_version) FROM __ducklake_metadata_ducklake.ducklake_schema_versions where table_id = 1
----
1

# ADD COLUMN SHOULD increment schema_version
statement ok
ALTER TABLE ducklake.test ADD COLUMN c BIGINT;

# max(schema_version) is 3 because schema_version was incremented globally, but not in the ducklake_schema_version
# when the SET SORTED BY statement executed
query I
SELECT max(schema_version) FROM __ducklake_metadata_ducklake.ducklake_schema_versions where table_id = 1
----
3

# SET SORTED BY after ADD COLUMN should NOT increment
statement ok
ALTER TABLE ducklake.test SET SORTED BY (a DESC, c ASC);

query I
SELECT max(schema_version) FROM __ducklake_metadata_ducklake.ducklake_schema_versions where table_id = 1
----
3

# RENAME COLUMN SHOULD increment schema_version
statement ok
ALTER TABLE ducklake.test RENAME COLUMN b TO b_renamed;

query I
SELECT max(schema_version) FROM __ducklake_metadata_ducklake.ducklake_schema_versions where table_id = 1
----
5

# SET SORTED BY with new column name should NOT increment
statement ok
ALTER TABLE ducklake.test SET SORTED BY (b_renamed ASC);

query I
SELECT max(schema_version) FROM __ducklake_metadata_ducklake.ducklake_schema_versions where table_id = 1
----
5

# DROP COLUMN SHOULD increment schema_version
statement ok
ALTER TABLE ducklake.test DROP COLUMN c;

query I
SELECT max(schema_version) FROM __ducklake_metadata_ducklake.ducklake_schema_versions where table_id = 1
----
7
