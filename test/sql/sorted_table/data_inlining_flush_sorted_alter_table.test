# name: test/sql/sorted_table/data_inlining_flush_sorted_alter_table.test
# description: alter table commands should not interfere with sorted inline flush
# group: [sorted_table]

require ducklake

require parquet

test-env DUCKLAKE_CONNECTION __TEST_DIR__/{UUID}.db

test-env DATA_PATH __TEST_DIR__


statement ok
ATTACH 'ducklake:${DUCKLAKE_CONNECTION}' AS ducklake (DATA_PATH '${DATA_PATH}/ducklake_inlining_flush_data', DATA_INLINING_ROW_LIMIT 10)

# Test with an alter table set sorted within the same transaction
statement ok
CREATE TABLE ducklake.test2(i INTEGER);

query I
SELECT COUNT(*) FROM ducklake.test2
----
0

loop i 0 10

statement ok
INSERT INTO ducklake.test2 VALUES (${i})

endloop

statement ok
BEGIN

# Ensure that we will respect a sort set within the same transaction
statement ok
ALTER TABLE ducklake.test2 SET SORTED BY (i DESC);

# flush inlined data
statement ok
CALL ducklake_flush_inlined_data('ducklake', table_name => 'test2')

query I
SELECT COUNT(*) FROM ducklake.test2
----
10

# Ordering should reflect the 'i DESC'
query III
SELECT rowid, snapshot_id, * FROM ducklake.test2
----
9	11	9
8	10	8
7	9	7
6	8	6
5	7	5
4	6	4
3	5	3
2	4	2
1	3	1
0	2	0

statement ok
COMMIT

# Ordering should reflect the 'i DESC' post commit also
query III
SELECT rowid, snapshot_id, * FROM ducklake.test2
----
9	11	9
8	10	8
7	9	7
6	8	6
5	7	5
4	6	4
3	5	3
2	4	2
1	3	1
0	2	0


# Ensure that other transaction local changes have no impact
statement ok
CREATE TABLE ducklake.test3(i INTEGER);

query I
SELECT COUNT(*) FROM ducklake.test3
----
0

loop i 0 10

statement ok
INSERT INTO ducklake.test3 VALUES (${i})

endloop

statement ok
BEGIN;

statement ok
ALTER TABLE ducklake.test3 SET SORTED BY (i DESC);

# Do some other kind of alter table on that table to make sure that it does not interfere
statement ok
ALTER TABLE ducklake.test3 ADD COLUMN new_column INTEGER;

# flush inlined data
statement ok
CALL ducklake_flush_inlined_data('ducklake', table_name => 'test3')

query I
SELECT COUNT(*) FROM ducklake.test3
----
10

# Ordering should reflect the 'i DESC'
query IIII
SELECT rowid, snapshot_id, * FROM ducklake.test3
----
9	23	9	NULL
8	22	8	NULL
7	21	7	NULL
6	20	6	NULL
5	19	5	NULL
4	18	4	NULL
3	17	3	NULL
2	16	2	NULL
1	15	1	NULL
0	14	0	NULL

statement ok
COMMIT;

# Ordering should reflect the 'i DESC' post commit also
query IIII
SELECT rowid, snapshot_id, * FROM ducklake.test3
----
9	23	9	NULL
8	22	8	NULL
7	21	7	NULL
6	20	6	NULL
5	19	5	NULL
4	18	4	NULL
3	17	3	NULL
2	16	2	NULL
1	15	1	NULL
0	14	0	NULL

