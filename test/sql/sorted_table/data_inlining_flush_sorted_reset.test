# name: test/sql/sorted_table/data_inlining_flush_sorted_reset.test
# description: RESET SORTED BY should flush data in the original order
# group: [sorted_table]

require ducklake

require parquet

test-env DUCKLAKE_CONNECTION __TEST_DIR__/{UUID}.db

test-env DATA_PATH __TEST_DIR__


statement ok
ATTACH 'ducklake:${DUCKLAKE_CONNECTION}' AS ducklake (DATA_PATH '${DATA_PATH}/ducklake_inlining_flush_data_reset', DATA_INLINING_ROW_LIMIT 10)

# SET SORTED BY then RESET SORTED BY within same transaction
statement ok
CREATE TABLE ducklake.reset_test(i INTEGER);

query I
SELECT COUNT(*) FROM ducklake.reset_test
----
0

loop i 0 10

statement ok
INSERT INTO ducklake.reset_test VALUES (${i})

endloop

statement ok
BEGIN;

statement ok
ALTER TABLE ducklake.reset_test SET SORTED BY (i DESC);

statement ok
ALTER TABLE ducklake.reset_test RESET SORTED BY;

# flush inlined data
statement ok
CALL ducklake_flush_inlined_data('ducklake', table_name => 'reset_test')

query I
SELECT COUNT(*) FROM ducklake.reset_test
----
10

# Ordering should retain the original order
query III
SELECT rowid, snapshot_id, * FROM ducklake.reset_test
----
0	2	0
1	3	1
2	4	2
3	5	3
4	6	4
5	7	5
6	8	6
7	9	7
8	10	8
9	11	9

statement ok
COMMIT;

# Ordering should retain the original order post commit also
query III
SELECT rowid, snapshot_id, * FROM ducklake.reset_test
----
0	2	0
1	3	1
2	4	2
3	5	3
4	6	4
5	7	5
6	8	6
7	9	7
8	10	8
9	11	9
