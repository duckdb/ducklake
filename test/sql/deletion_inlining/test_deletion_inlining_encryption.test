# name: test/sql/deletion_inlining/test_deletion_inlining_encryption.test
# description: Test ducklake deletion inlining with encryption
# group: [deletion_inlining]

require ducklake

require parquet

require httpfs

test-env DUCKLAKE_CONNECTION __TEST_DIR__/{UUID}.db

test-env DATA_PATH __TEST_DIR__

statement ok
ATTACH 'ducklake:${DUCKLAKE_CONNECTION}' AS ducklake (DATA_PATH '${DATA_PATH}/ducklake_deletion_inlining_encryption', ENCRYPTED, DATA_INLINING_ROW_LIMIT 10)

statement ok
use ducklake

# Create a table with enough data to create a file (exceeds inlining limit)
statement ok
CREATE TABLE t AS SELECT range a FROM range(50);

query II
SELECT COUNT(*), SUM(a) FROM t
----
50	1225

statement ok
DELETE FROM t WHERE a < 5

query II
SELECT COUNT(*), SUM(a) FROM t
----
45	1215

query I
SELECT COUNT(*) FROM GLOB('${DATA_PATH}/ducklake_deletion_inlining_encryption/**/*-delete.parquet')
----
0

statement ok
CALL ducklake_flush_inlined_data('ducklake')

query I
SELECT COUNT(*) FROM GLOB('${DATA_PATH}/ducklake_deletion_inlining_encryption/**/*-delete.parquet')
----
1

statement error
SELECT * FROM '${DATA_PATH}/ducklake_deletion_inlining_encryption/**/*-delete.parquet'
----
encrypted

query II
SELECT COUNT(*), SUM(a) FROM t
----
45	1215

query II
SELECT COUNT(*), SUM(a) FROM t AT (VERSION => 1)
----
50	1225
