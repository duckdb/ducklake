# name: test/sql/deletion_inlining/test_deletion_from_file_and_inserted_inlining_non_sequential.test
# description: test ducklake deletion inlining from file and inserted inline with non-sequential data
# group: [deletion_inlining]

require ducklake

require parquet

test-env DUCKLAKE_CONNECTION __TEST_DIR__/{UUID}.db

test-env DATA_PATH __TEST_DIR__

statement ok
ATTACH 'ducklake:${DUCKLAKE_CONNECTION}' AS ducklake (DATA_PATH '${DATA_PATH}/test_deletion_from_file_and_inserted_inlining_non_sequential', DATA_INLINING_ROW_LIMIT 5, METADATA_CATALOG 'ducklake_meta')

statement ok
use ducklake

statement ok
CREATE TABLE t AS SELECT * FROM (VALUES (42), (17), (89), (3), (156), (71), (28), (200), (55), (102)) AS v(a);

statement ok
INSERT INTO t VALUES (999), (500), (777);

statement ok
DELETE FROM t WHERE a = 71 OR a = 500;

query I
SELECT count(*) FROM t
----
11

query IIIII
SELECT table_id, begin_snapshot, end_snapshot, delete_count, partial_max FROM ducklake_meta.ducklake_delete_file ORDER BY begin_snapshot
----

query IIII
FROM ducklake_meta.ducklake_inlined_data_1_1 ORDER BY ALL
----
10	2	NULL	999
11	2	3	500
12	2	NULL	777

query III
SELECT file_id, row_id, begin_snapshot FROM ducklake_meta.ducklake_inlined_delete_1 ORDER BY row_id
----
0	5	3

statement ok
CALL ducklake_flush_inlined_data('ducklake')

query IIIII
SELECT table_id, begin_snapshot, end_snapshot, delete_count, partial_max FROM ducklake_meta.ducklake_delete_file ORDER BY ALL
----
1	3	NULL	1	3
1	3	NULL	1	NULL

query I
SELECT count(*) FROM t
----
11
