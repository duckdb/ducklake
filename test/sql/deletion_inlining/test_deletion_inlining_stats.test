# name: test/sql/deletion_inlining/test_deletion_inlining_stats.test
# description: Test ducklake deletion inlining statistics tracking
# group: [deletion_inlining]

require ducklake

require parquet

test-env DUCKLAKE_CONNECTION __TEST_DIR__/{UUID}.db

test-env DATA_PATH __TEST_DIR__

statement ok
ATTACH 'ducklake:${DUCKLAKE_CONNECTION}' AS ducklake (DATA_PATH '${DATA_PATH}/deletion_inlining_stats', METADATA_CATALOG 'ducklake_meta', DATA_INLINING_ROW_LIMIT 10)

statement ok
USE ducklake

statement ok
CREATE TABLE t AS SELECT range a FROM range(50);

statement ok
DELETE FROM t WHERE a < 5

statement ok
CALL ducklake_flush_inlined_data('ducklake')

query II
SELECT delete_count, begin_snapshot FROM ducklake_meta.ducklake_delete_file
----
5	2

query I
SELECT COUNT(*) FROM ducklake_meta.ducklake_inlined_delete_1
----
0

query II
SELECT record_count, next_row_id FROM ducklake_meta.ducklake_table_stats
----
50	50

query I
SELECT COUNT(*) FROM t
----
45

statement ok
DELETE FROM t WHERE a >= 45

query I
SELECT COUNT(*) FROM t
----
40

statement ok
CALL ducklake_flush_inlined_data('ducklake')

query II
SELECT delete_count, begin_snapshot FROM ducklake_meta.ducklake_delete_file ORDER BY begin_snapshot
----
10	2

query I
SELECT COUNT(*) FROM t
----
40
