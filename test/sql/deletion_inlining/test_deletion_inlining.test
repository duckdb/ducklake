# name: test/sql/deletion_inlining/test_deletion_inlining.test
# description: test ducklake deletion inlining, simple case
# group: [deletion_inlining]

require ducklake

require parquet

test-env DUCKLAKE_CONNECTION __TEST_DIR__/{UUID}.db

test-env DATA_PATH __TEST_DIR__

statement ok
ATTACH 'ducklake:${DUCKLAKE_CONNECTION}' AS ducklake (DATA_PATH '${DATA_PATH}/test_deletion_inlining',DATA_INLINING_ROW_LIMIT 10,  METADATA_CATALOG 'ducklake_meta')

statement ok
use ducklake

statement ok
CREATE TABLE t AS SELECT range a FROM range(50);

# This creates a deletion file (19 rows deleted, which exceeds the inlining threshold)
statement ok
DELETE FROM T where a < 5

query IIII
SELECT table_id, begin_snapshot, end_snapshot, delete_count FROM ducklake_meta.ducklake_delete_file
----

# Verify the first inlined deletion (5 rows: 0-4)
query III
SELECT file_id, row_id, begin_snapshot FROM ducklake_meta.ducklake_inlined_delete_1 ORDER BY row_id
----
0	0	2
0	1	2
0	2	2
0	3	2
0	4	2

query I
SELECT COUNT(*) FROM t
----
45

statement ok
DELETE FROM T where a < 9

query I
SELECT COUNT(*) FROM t
----
41

query III
SELECT file_id, row_id, begin_snapshot FROM ducklake_meta.ducklake_inlined_delete_1 ORDER BY row_id
----
0	0	2
0	1	2
0	2	2
0	3	2
0	4	2
0	5	3
0	6	3
0	7	3
0	8	3

statement ok
DELETE FROM T where a = 15

query I
SELECT COUNT(*) FROM t
----
40

query III
SELECT file_id, row_id, begin_snapshot FROM ducklake_meta.ducklake_inlined_delete_1 ORDER BY row_id
----
0	0	2
0	1	2
0	2	2
0	3	2
0	4	2
0	5	3
0	6	3
0	7	3
0	8	3
0	15	4

# # Let's flush
statement ok
CALL ducklake_flush_inlined_data('ducklake')

query III
SELECT file_id, row_id, begin_snapshot FROM ducklake_meta.ducklake_inlined_delete_1 ORDER BY row_id
----

query I
SELECT count(*) FROM GLOB('${DATA_PATH}/test_deletion_inlining/**/*-delete.parquet')
----
1

# Verify new deletion file schema - should have _ducklake_internal_snapshot_id column
# since it was created from flushing inlined deletions
query II
SELECT column_name, column_type FROM (DESCRIBE SELECT * FROM '${DATA_PATH}/test_deletion_inlining/**/*-delete.parquet') ORDER BY column_name
----
_ducklake_internal_snapshot_id	BIGINT
file_path	VARCHAR
pos	BIGINT

query IIIII
SELECT table_id, begin_snapshot, end_snapshot, delete_count, partial_max FROM ducklake_meta.ducklake_delete_file ORDER BY begin_snapshot
----
1	2	NULL	10	4

# After flush, subsequent small deletes continue to be inlined
# (they'll be merged with the delete file on the next flush)
statement ok
DELETE FROM T where a < 15

statement ok
DELETE FROM T where a > 45

# New deletions should be inlined (6 from a<15 + 4 from a>45 = 10 rows)
query III
SELECT file_id, row_id, begin_snapshot FROM ducklake_meta.ducklake_inlined_delete_1 ORDER BY row_id
----
0	9	6
0	10	6
0	11	6
0	12	6
0	13	6
0	14	6
0	46	7
0	47	7
0	48	7
0	49	7

query I
SELECT COUNT(*) FROM t
----
30

# Delete file should still have 10 deletions from the first flush
query IIIII
SELECT table_id, begin_snapshot, end_snapshot, delete_count, partial_max FROM ducklake_meta.ducklake_delete_file ORDER BY begin_snapshot
----
1	2	NULL	10	4

statement ok
CALL ducklake_flush_inlined_data('ducklake')

query IIIII
SELECT table_id, begin_snapshot, end_snapshot, delete_count, partial_max FROM ducklake_meta.ducklake_delete_file ORDER BY begin_snapshot
----
1	2	NULL	20	7

query I
SELECT COUNT(*) FROM t
----
30

# After flush, active inlined deletions should be empty
query III
SELECT file_id, row_id, begin_snapshot FROM ducklake_meta.ducklake_inlined_delete_1 ORDER BY row_id
----

# Now let's do an insert that is fully inlined
statement ok
insert into t values (51),(52),(53),(54),(55);

# Let's do an insertion that does not get inlined
statement ok
insert into t values (56),(57),(58),(59),(60),(61),(62),(63),(64),(65),(66),(67),(68),(69),(70);

query I
SELECT COUNT(*) FROM T
----
50

# Let's do a deletion that deletes files from all three
statement ok
delete from t where a = 40 or a = 53 or a > 65;

query I
SELECT COUNT(*) FROM T
----
43

# Only check active (non-flushed) deletions
query III
SELECT file_id, row_id, begin_snapshot FROM ducklake_meta.ducklake_inlined_delete_1 ORDER BY row_id
----
4	10	11
4	11	11
4	12	11
4	13	11
4	14	11
0	40	11

query IIII
FROM ducklake_meta.ducklake_inlined_data_1_1 order by ALL
----
50	9	NULL	51
51	9	NULL	52
52	9	11	53
53	9	NULL	54
54	9	NULL	55

statement ok
CALL ducklake_flush_inlined_data('ducklake')

query IIIII
SELECT table_id, begin_snapshot, end_snapshot, delete_count, partial_max FROM ducklake_meta.ducklake_delete_file ORDER BY begin_snapshot
----
1	2	NULL	21	11
1	11	NULL	1	NULL
1	11	NULL	5	11

query I
FROM T order by a
----
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
41
42
43
44
45
51
52
54
55
56
57
58
59
60
61
62
63
64
65

query I
SELECT count(*) FROM GLOB('${DATA_PATH}/test_deletion_inlining/**/*-delete.parquet')
----
5

query I
select count(*) FROM ducklake_meta.ducklake_files_scheduled_for_deletion
----
2


statement ok
CALL ducklake_cleanup_old_files(
    'ducklake',
    cleanup_all => true
);

query I
SELECT count(*) FROM GLOB('${DATA_PATH}/test_deletion_inlining/**/*-delete.parquet')
----
3

query I
select count(*) FROM ducklake_meta.ducklake_files_scheduled_for_deletion
----
0
