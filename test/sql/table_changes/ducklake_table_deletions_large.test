# name: test/sql/table_changes/ducklake_table_deletions_large.test
# description: test ducklake_table_deletions with an over vector size data
# group: [table_changes]

require ducklake

require parquet

test-env DUCKLAKE_CONNECTION __TEST_DIR__/{UUID}.db

test-env DATA_PATH __TEST_DIR__

statement ok
ATTACH 'ducklake:${DUCKLAKE_CONNECTION}' AS ducklake (DATA_PATH '${DATA_PATH}/ducklake_table_deletions_large_files')

statement ok
use ducklake

statement ok
CREATE TABLE test(i INTEGER);

statement ok
INSERT INTO test FROM range(10000)

query I
SELECT COUNT(*) FROM test
----
10000

statement ok
DELETE FROM test WHERE i < 1200

query I
SELECT COUNT(*) FROM test
----
8800

statement ok
DELETE FROM test WHERE i >= 1200 AND i < 2400

query I
SELECT COUNT(*) FROM test
----
7600

statement ok
DELETE FROM test WHERE i >= 2400 AND i < 3600

query I
SELECT COUNT(*) FROM test
----
6400

statement ok
DELETE FROM test WHERE i >= 3600 AND i < 4800

query I
SELECT COUNT(*) FROM test
----
5200

statement ok
DELETE FROM test WHERE i >= 4800 AND i < 6000

query I
SELECT COUNT(*) FROM test
----
4000

query I
SELECT MIN(i) FROM test
----
6000

query I
SELECT MAX(i) FROM test
----
9999

query I
SELECT COUNT(*) FROM table_deletions('test', 3, 3)
----
1200


# snapshot 4 deleted rows 1200-2399 (1200 rows)
query I
SELECT COUNT(*) FROM table_deletions('test', 4, 4)
----
1200

# get all deletions from the beginning
query I
SELECT COUNT(*) FROM table_deletions('test', 0, 7)
----
6000

# snapshot 8: delete remaining 4000 rows (6000-9999)
statement ok
DELETE FROM test WHERE i >= 6010

query I
SELECT COUNT(*) FROM test
----
10

# snapshot 8 deleted rows 6000-9999 (4000 rows)
query I
SELECT COUNT(*) FROM table_deletions('test', 8, 8)
----
3990

# get all deletions from the beginning (should be all 10000)
query I
SELECT COUNT(*) FROM table_deletions('test', 0, 8)
----
9990
